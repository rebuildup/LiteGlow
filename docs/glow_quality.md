# 高品質なGlowとは（LiteGlow方針）

## 目的
「強度を上げても破綻しない」「エッジが飛ばない」「HDR(32bpc)で安定」「時間方向にチラつかない」Glowを、GPUで高速に実行する。

## “高品質”の要件（実務上の定義）
- **入力色空間に対して一貫**: 32bpc(浮動小数)で 1.0 を超える値があっても破綻しない。
- **閾値が滑らか**: Threshold近傍で段差が出ない（Soft-knee）。
- **ブラーが滑らか**: 近似ガウスとして見える（リング/段差/エイリアスが出にくい）。
- **合成が安定**: Strengthが大きくても NaN/Inf/極端な飽和になりにくい（強度マッピング）。
- **メモリアクセスが正しい**: SRV/UAVの型とシェーダ側の読み書きが一致している（ここが崩れると「飛び」「白飛び」が起きやすい）。

## LiteGlowのGPUパイプライン（現状）
1. **Bright Pass**: 32bpcの入力から輝度を抽出（Soft-knee）。品質設定により downsample。
2. **Separable Blur**: 水平→垂直（Highのみ反復して高品質寄り）。
3. **Blend**: Glowをバイリニアでアップサンプルし、Strengthを安定マッピングして合成。

## 破綻（飛び/白の異常）の主因
- SRV/UAV を **StructuredBufferとして読んでいる**のに、実際は **raw bufferビュー（ByteAddressBuffer前提）**だった場合、
  インデックス/ストライド解釈が崩れ、ランダムな値（巨大値/NaN相当）を読む→白飛び/線/飛びが起きやすい。

## 速度の考え方
- 2Kで30ms未満を狙うには、「半径に比例してタップ数が増えるブラー」を避け、**定数タップ近似**か **マルチスケール（ピラミッド）**へ寄せるのが定番。
- 次の改善候補（未実装）:
  - マルチスケールBloom（2x/4x/8x）で“広がり”を出しつつ各段のタップを小さくする
  - groupsharedタイル（共有メモリ）でグローバルメモリアクセスを削減する

## 計測チェックリスト
- After Effectsプロジェクトが **32bpc**（GPU_BGRA128パス前提）
- エフェクト名に **GPUバッジ** が付く（GPUパスが選ばれている目安）
- 生成物に `DirectX_Assets/*.cso` があり、AEXの隣にコピーされている（`output/DirectX_Assets` 等）
- Strengthを上げた時に「飛び」が出る場合は、まず **シェーダの読み書き型（raw/structured/texture）不一致**を疑う
- 「白を超える」= 32bpcでは **HDRで1.0超えが出ているだけ**の場合もある。表示白に収めたい場合は、合成後に **ロールオフ（>1の時だけスケール等）**を入れる。
  - LiteGlowでは `Highlight Rolloff` でON/OFFできる（ONのとき、RGB最大値が1を超えた場合のみスケールして抑制）。
